# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import argparse
from lib import CVEs
from lib.Config import Configuration
import lib.Query as query
from lib.Printers import CVEFilePrinter 
from datetime import datetime
import dateutil.parser as date_parser

if __name__ == "__main__":
    argParser = argparse.ArgumentParser(description='Search for vulnerabilities in the National Vulnerability DB. Data from http://nvd.nist.org.')
    argParser.add_argument('-p', type=str, help='S = search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
    argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')
    argParser.add_argument('-t', default=False, action='store_true', help='Print a summary of vulnerability types for a chosen software product')
    argParser.add_argument('-b', type=str, help='Filter results by the year')
    argParser.add_argument('-e', type=str, help='Filter results by the year')
    argParser.add_argument('-v', type=str, help='')
    argParser.add_argument('-a', type=str, help='')
    argParser.add_argument('-c', type=str, help='')


    args = argParser.parse_args()
    cvss_lower_bound = args.s if args.s else 0.0

    rankinglookup = ''
    namelookup = ''
    capeclookup = ''

    cves = CVEs.last(rankinglookup=rankinglookup, namelookup=namelookup, capeclookup=capeclookup)
    printer = CVEFilePrinter(cves=cves, rankinglookup=rankinglookup, namelookup=namelookup, capeclookup=capeclookup)

    if args.p:
        if args.t:
            (total, hits) = query.count_keywords_special(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, year=date)
            print("TOTAL: %i" % total)
            print ("-------------------------------------------------\n")
            for (category, count) in hits.items():
                print("%s ==> %i" % (category, count))
            print ("-------------------------------------------------\n")
        else:
            results = query.product_search_special(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, vector=args.v, auth=args.a, complx=args.c)
            printer.print_txt(results)
        '''
        if args.t:
            (total, hits) = query.count_keywords(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, year=date)
            print("TOTAL: %i" % total)
            print ("-------------------------------------------------\n")
            for (category, count) in hits.items():
                print("%s ==> %i" % (category, count))
            print ("-------------------------------------------------\n")
        else:
            results = query.product_search(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, sort_type=sort_type, year=date)
            if args.o == "csv":
                printer.print_csv(results, args.v)
            if args.o == "html":
                printer.print_html(results, args.p)
            elif args.o == "xml":
                printer.print_xml(results)
            elif args.o == "json": 
                printer.print_json(results)
            else:
                printer.print_txt(results)
        '''