# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import argparse
from lib import CVEs
from lib.Config import Configuration
import lib.Query as query
from lib.Printers import CVEFilePrinter 
from datetime import datetime
import dateutil.parser as date_parser

if __name__ == "__main__":
    argParser = argparse.ArgumentParser(description='Search for vulnerabilities in the National Vulnerability DB. Data from http://nvd.nist.org.')
    argParser.add_argument('-p', type=str, help='S = search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
    argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')
    argParser.add_argument('-k', type=str, help='Search for a cpecific pattern or keyword in the summary')
    argParser.add_argument('-b', type=int, help='Filter results starting from a year')
    argParser.add_argument('-e', type=int, help='Filter results up to a certain year')
    argParser.add_argument('-t', default=False, action='store_true', help='Print a summary of vulnerability types for a chosen software product')


    args = argParser.parse_args()
    cvss_lower_bound = args.s if args.s else 0.0
    product = args.p
    keyword = args.k if args.k else '.*'
    start_year = args.b if args.b else 1997
    end_year = args.e if args.e else 2050
    start_year = date_parser.parse(str(start_year) + '-01-01').isoformat()
    end_year = date_parser.parse(str(end_year+1) + '-01-01').isoformat()

    cves = CVEs.last(rankinglookup='', namelookup='', capeclookup='')
    printer = CVEFilePrinter(cves=cves, rankinglookup='', namelookup='', capeclookup='')

    if args.p:
        if args.t:
            (total, hits) = query.count_keywords(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, start_year=start_year, end_year=end_year)
            print("TOTAL: %i" % total)
            print ("-------------------------------------------------\n")
            for (category, count) in hits.items():
                print("%s ==> %i" % (category, count))
            print ("-------------------------------------------------\n")  
        else:
            results = query.product_search(product_pattern=product, keyword_pattern=keyword, cvss_lower_bound=cvss_lower_bound, start_year=start_year, end_year=end_year)
            printer.print_txt(results)

