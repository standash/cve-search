# Imports
import os, re, collections
import sys,dateutil.parser
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import argparse
from lib import CVEs
from lib.Config import Configuration
import lib.Query as query
from lib.Printers import CVEFilePrinter 
from datetime import datetime
import dateutil.parser as date_parser
import csv

def print_summary(total, hits):
    print("TOTAL: %i" % total)
    print ("-------------------------------------------------\n")
    for (category, count) in hits.items():
        print("%s: %i" % (category, count))
    print ("-------------------------------------------------\n")  

def print_distinct_cves_to_excel(product, keyword, cvss_lower_bound):
    csv_out = csv.writer(sys.stdout, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
    csv_out.writerow(["FOSS", "YEAR", "CVE", "CVSS", "SUMMARY"])
    for year in range(1997,2016):
        start_year = date_parser.parse(str(year) + '-01-01').isoformat()
        end_year = date_parser.parse(str(year+1) + '-01-01').isoformat()
        results = query.product_search(product_pattern=product, keyword_pattern=keyword, cvss_lower_bound=cvss_lower_bound, start_year=start_year, end_year=end_year)
        for item in results:
            csv_out.writerow([product, str(year), item['id'], item['cvss'], item['summary']])

def print_cve_counts_by_year_to_excel(product, keyword, cvss_lower_bound):
    csv_out = csv.writer(sys.stdout, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
    csv_out.writerow(["YEAR", "CVES"])
    results = query.product_search(product_pattern=product, keyword_pattern=keyword, cvss_lower_bound=cvss_lower_bound)
    year = '1997'
    dates = []
    for item in results:
        date = dateutil.parser.parse(item['Published'])
        dates.append(date)
    dates.sort()
    counter = 1
    if len(dates) > 0:
        year = dates.pop(0).year
        for date in dates:
            if year == date.year:
                counter += 1
            else:
                csv_out.writerow([year, counter])
                counter = 1
                year = date.year
        csv_out.writerow([year, counter])


def print_cve_counts_by_month_to_excel(product, keyword, cvss_lower_bound, access_complexity):
    csv_out = csv.writer(sys.stdout, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
    csv_out.writerow(["YEAR-MONTH", "CVES"])
    results = query.product_search(product_pattern=product, keyword_pattern=keyword, cvss_lower_bound=cvss_lower_bound, access_complexity=access_complexity)
    year = '1997'
    month = '01'
    dates = []
    for item in results:
        date = dateutil.parser.parse(item['Published'])
        dates.append(date)
    dates.sort()
    counter = 1
    if len(dates) > 0:
        date = dates.pop(0)
        year = date.year
        month = date.month
        for date in dates:
            if year == date.year and month == date.month:
                counter += 1
            else:
                csv_out.writerow([str(year)+'-'+str(month), counter])
                counter = 1
                year = date.year
                month = date.month
        csv_out.writerow([str(year)+'-'+str(month), counter])


def affected_versions_distribution(seed_cpe, results, cvss_lower_bound):
    versions = {}
    pattern = re.compile(r".*%s.*" % seed_cpe)
    for r in results:
        for cpe in r["vulnerable_configuration"]:
            if pattern.match(cpe):
                versions[cpe] = 0

    results = query.product_search(product_pattern=seed_cpe, cvss_lower_bound=cvss_lower_bound)
    for r in results:
        for cpe in r["vulnerable_configuration"]:
            for v in versions:
                if v == cpe:
                    versions[cpe] = versions[cpe] + 1

    csv_out = csv.writer(sys.stdout, delimiter=',', quotechar='|', quoting=csv.QUOTE_MINIMAL)
    csv_out.writerow(["VERSION", "AFFECTED_BY"])
    od = collections.OrderedDict(sorted(versions.items()))
    for k,v in od.items():
        versions_list = k
        csv_out.writerow([k,v])

if __name__ == "__main__":
    argParser = argparse.ArgumentParser(description='Search for vulnerabilities in the National Vulnerability DB. Data from http://nvd.nist.org.')
    argParser.add_argument('-p', type=str, help='S = search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
    argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')
    argParser.add_argument('-k', type=str, help='Search for a cpecific pattern or keyword in the summary')
    argParser.add_argument('-b', type=int, help='Filter results starting from a year')
    argParser.add_argument('-e', type=int, help='Filter results up to a certain year')
    argParser.add_argument('-t', default=False, action='store_true', help='Print a summary of vulnerability types for a chosen software product')
    argParser.add_argument('-d', default=False, action='store_true', help='Print information on distinct CVEs to excel')
    argParser.add_argument('-y', default=False, action='store_true', help='Print information on CVE counts grouped by years to excel')
    argParser.add_argument('-m', default=False, action='store_true', help='Print information on CVE counts grouped by months to excel')
    argParser.add_argument('-v', default=False, action='store_true', help='Print information on CVE counts grouped by versions (CPE identifiers)')
    argParser.add_argument('-c', type=str, help='Access complexity')


    args = argParser.parse_args()

    cvss_lower_bound = args.s if args.s else 0.0
    product = args.p
    keyword = args.k if args.k else '.*'

    start_year = args.b if args.b else 1997
    end_year = args.e if args.e else 2050
    start_year = date_parser.parse(str(start_year) + '-01-01').isoformat()
    end_year = date_parser.parse(str(end_year+1) + '-01-01').isoformat()

    cves = CVEs.last(rankinglookup='', namelookup='', capeclookup='')
    printer = CVEFilePrinter(cves=cves, rankinglookup='', namelookup='', capeclookup='')

    if args.p:
        if args.d:
            print_distinct_cves_to_excel(product, keyword, cvss_lower_bound)
        elif args.y:
            print_cve_counts_by_year_to_excel(product, keyword, cvss_lower_bound)
        elif args.m:
            access_complexity = args.c if args.c != None else ".*"
            print_cve_counts_by_month_to_excel(product, keyword, cvss_lower_bound, access_complexity)
        elif args.t:
            (total, hits) = query.count_keywords(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, start_year=start_year, end_year=end_year)
            print_summary(total, hits)
        else:
            results = query.product_search(product_pattern=product, keyword_pattern=keyword, cvss_lower_bound=cvss_lower_bound, start_year=start_year, end_year=end_year)
            if args.v:
                affected_versions_distribution(product, results, cvss_lower_bound)
            else:
                printer.print_txt(results)


