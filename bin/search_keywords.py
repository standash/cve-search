# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import re
import argparse
from lib import CVEs
from lib.Config import Configuration
import lib.Query as query
from lib.Printers import CVEFilePrinter 
from datetime import datetime
import dateutil.parser as date_parser

if __name__ == '__main__':
    argParser = argparse.ArgumentParser(description='Search and rank vulnerabilities from NVD')
    argParser.add_argument('-p', type=str, help='Search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
    argParser.add_argument('-k', type=str, help='Search for a cpecific pattern or keyword in the summary')
    argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')
    argParser.add_argument('-l', action='store_true', help='Sort in descending mode')
    argParser.add_argument('-y', type=str, help='Filter results by the year')
    args = argParser.parse_args()

    cves = CVEs.last()
    printer = CVEFilePrinter(cves=cves)

    cvss_lower_bound = args.s if args.s else 0.0
    sort_type = -1 if args.l else 1
    
    date = '1984'
    if args.y:
        try:
            date = args.y
            datetime.strptime(date, '%Y')
            date = date_parser.parse(date+'-01-01').isoformat()
        except ValueError:
            print('ERROR: wrong year format')
            sys.exit(0)
    
    if args.p:
        if args.k:
            results = query.product_search(product_pattern=args.p, keyword_pattern=args.k, 
                                           cvss_lower_bound=cvss_lower_bound, sort_type=sort_type, year=date)
            printer.print_txt(results)
        else:
            print ("\n-------------------------------------------------")
            (total, hits) = query.count_keywords(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, year=date)
            print("TOTAL: %i" % total)
            print ("-------------------------------------------------\n")
            for (category, count) in hits.items():
                print("%s ==> %i" % (category, count))
            print ("-------------------------------------------------\n")