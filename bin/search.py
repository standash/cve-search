# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import argparse
from lib import CVEs
from lib.Config import Configuration
import lib.Query as query
from lib.Printers import CVEFilePrinter 

if __name__ == "__main__":

    argParser = argparse.ArgumentParser(description='Search for vulnerabilities in the National Vulnerability DB. Data from http://nvd.nist.org.')
    argParser.add_argument('-p', type=str, help='S = search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
    argParser.add_argument('-f', type=str, help='F = free text search in vulnerability summary')
    argParser.add_argument('-c', action='append', help='search one or more CVE-ID')
    argParser.add_argument('-o', type=str, help='O = output format [csv|html|json|xml|cveid]')
    argParser.add_argument('-l', action='store_true', help='sort in descending mode')
    argParser.add_argument('-n', action='store_true', help='lookup complete cpe (Common Platform Enumeration) name for vulnerable configuration')
    argParser.add_argument('-r', action='store_true', help='lookup ranking of vulnerable configuration')
    argParser.add_argument('-a', default=False, action='store_true', help='Lookup CAPEC for related CWE weaknesses')
    argParser.add_argument('-v', type=str, help='vendor name to lookup in reference URLs')
    argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')

    args = argParser.parse_args()
    cvss_lower_bound = args.s if args.s else 0.0
    sort_type = -1 if args.l else 1

    rankinglookup = args.r
    namelookup = args.n
    capeclookup = args.a
    
    cves = CVEs.last(rankinglookup=rankinglookup, namelookup=namelookup, capeclookup=capeclookup)
    printer = CVEFilePrinter(cves=cves, rankinglookup=rankinglookup, namelookup=namelookup, capeclookup=capeclookup)

    if args.p:
        results = query.product_search(product_pattern=args.p, cvss_lower_bound=cvss_lower_bound, sort_type=sort_type)
        if args.o == "csv":
            printer.print_csv(results, args.v)
        if args.o == "html":
            printer.print_html(results, args.p)
        elif args.o == "xml":
            printer.print_xml(results)
        elif args.o == "json": 
            printer.print_json(results)
        else:
            printer.print_txt(results)

    if args.f:
        results = query.free_search(pattern, sort_type)
        print(results)
    if args.c:
        results = query.cve_search(args.c, sort_type)
        if args.o == "txt":
            printer.print_txt(results)
        else:
            printer.print_cve(results)

    