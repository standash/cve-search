# Imports
import os
import sys
runPath = os.path.dirname(os.path.realpath(__file__))
sys.path.append(os.path.join(runPath, ".."))

import argparse
from lib import CVEs
from urllib.parse import urlparse
import json
from bson import json_util
from lib.Config import Configuration
import lib.Query as query

class Search():
    def __init__(self):
        argParser = argparse.ArgumentParser(description='Search for vulnerabilities in the National Vulnerability DB. Data from http://nvd.nist.org.')
        argParser.add_argument('-p', type=str, help='S = search product, e.g. o:microsoft:windows_7 or o:cisco:ios:12.1')
        argParser.add_argument('-f', type=str, help='F = free text search in vulnerability summary')
        argParser.add_argument('-c', action='append', help='search one or more CVE-ID')
        argParser.add_argument('-o', type=str, help='O = output format [csv|html|json|xml|cveid]')
        argParser.add_argument('-l', action='store_true', help='sort in descending mode')
        argParser.add_argument('-n', action='store_true', help='lookup complete cpe (Common Platform Enumeration) name for vulnerable configuration')
        argParser.add_argument('-r', action='store_true', help='lookup ranking of vulnerable configuration')
        argParser.add_argument('-a', default=False, action='store_true', help='Lookup CAPEC for related CWE weaknesses')
        argParser.add_argument('-v', type=str, help='vendor name to lookup in reference URLs')
        argParser.add_argument('-s', type=float, help='Search for CVSS scores greater or equal than the value specified')

        args = argParser.parse_args()
        cvss_lower_bound = args.s if args.s else 0.0
        sort_type = -11 if args.l else 1

        self.rankinglookup = args.r
        self.namelookup = args.n
        self.capeclookup = args.a
        
        self.cves = CVEs.last(rankinglookup=self.rankinglookup, namelookup=self.namelookup, capeclookup=self.capeclookup)
        search_results = [] 

        if args.p:
            results = query.productsearch(args.p, cvss_lower_bound, sort_type)
            if args.o == "csv":
                self.print_csv(results, args.v)
            if args.o == "html":
                self.print_html(results, args.p)
            elif args.o == "xml":
                self.print_xml(results)
            elif args.o == "json": 
                self.print_json(results)
            else:
                self.print_txt(results)

        if args.f:
            results = query.freesearch(pattern, sort_type)
            print(results)
        if args.c:
            results = query.cvesearch(args.c, sort_type)
            self.print_cve(results)

    def print_cve(self, items):
        for item in items:
            print(item)
            if not self.namelookup and not self.rankinglookup and not self.capeclookup:
                print(json.dumps(item, sort_keys=True, default=json_util.default))
            else:
                if "vulnerable_configuration" in item:
                    vulconf = []
                    ranking = []
                    for conf in item['vulnerable_configuration']:
                        if self.namelookup:
                            vulconf.append(cves.getcpe(cpeid=conf))
                        if rankinglookup:
                            rank = self.cves.getranking(cpeid=conf)
                            if rank and rank not in ranking:
                                ranking.append(rank)
                    if self.namelookup:
                        item['vulnerable_configuration'] = vulconf
                    if rankinglookup:
                        item['ranking'] = ranking
                    if "cwe" in item and self.capeclookup:
                        if item['cwe'].lower() != 'unknown':
                            item['capec'] = self.cves.getcapec(cweid=(item['cwe'].split('-')[1]))
                    print(json.dumps(item, sort_keys=True, default=json_util.default))

    def print_txt(self, items):
        for item in items:
            print("CVE\t: " + item['id'])
            print("DATE\t: " + item['Published'])
            print("CVSS\t: " + str(item['cvss']))
            print(item['summary'])
            print("\nReferences:")
            print("-----------")
            for entry in item['references']:
                print(entry)
            print("\nVulnerable Configs:")
            print("-------------------")
            for entry in item['vulnerable_configuration']:
                if not self.namelookup:
                    print(entry)
                else:
                    print(self.cves.getcpe(cpeid=entry))
            print("\n\n")

    def print_csv(self, items, vendor):
        for item in items:
            refs = []
            for entry in item['references']:
                if vendor is not None:
                    url = urlparse(entry)
                    hostname = url.netloc
                    if re.search(args.v, hostname):
                        refs.append(entry)
            if not refs:
                refs = "[no vendor link found]"
            if self.namelookup:
                nl = " ".join(item['vulnerable_configuration'])
            csvoutput = csv.writer(sys.stdout, delimiter='|', quotechar='|', quoting=csv.QUOTE_MINIMAL)
            if not self.namelookup:
                csvoutput.writerow([item['id'], item['Published'], item['cvss'], item['summary'], refs])
            else:
                csvoutput.writerow([item['id'], item['Published'], item['cvss'], item['summary'], refs, nl])

    def print_html(self, items, header):
        print("<html><body><h1>CVE search " + header + " </h1>")
        for item in items:
            print("<h2>" + item['id'] + "<br></h2>CVSS score: " + str(item['cvss']) + "<br>" + "<b>" + item['Published'] + "<b><br>" + item['summary'] + "<br>")
            print("References:<br>")
            for entry in item['references']:
                print(entry + "<br>")
            print("<hr><hr>") 
        print("</body></html>")

    def print_xml(self, items):
        from xml.etree.ElementTree import Element, SubElement, tostring
        from xml.sax.saxutils import escape as SaxEscape
        r = Element('cve-search')
        for item in items:
            c = SubElement(r, 'id')
            c.text = item['id']
            c = SubElement(r, 'Published')
            c.text = item['Published']
            c = SubElement(r, 'cvss')
            c.text = str(item['cvss'])
            c = SubElement(r, 'summary')
            c.text = SaxEscape(item['summary'])
            for e in item['references']:
                c = SubElement(r, 'references')
                c.text = SaxEscape(e)
            for e in item['vulnerable_configuration']:
                c = SubElement(r, 'vulnerable_configuration')
                c.text = SaxEscape(e)       
            s = tostring(r).decode("utf-8")
            print(s)

    def print_json(self, items):
        for item in items:
            print_cve(item) 

if __name__ == "__main__":
    Search()